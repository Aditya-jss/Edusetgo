<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Debug - EduSetGo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>Payment Debug Tool</h1>
        <p>This tool helps debug payment issues and fix payment data.</p>
        
        <div class="debug-section">
            <h3>Authentication Check</h3>
            <button onclick="checkAuth()">Check Authentication</button>
            <div id="authStatus" class="status" style="display: none;"></div>
            <div id="authData" class="log" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>User Document Check</h3>
            <button onclick="checkUserDocument()">Check User Document</button>
            <div id="userStatus" class="status" style="display: none;"></div>
            <div id="userData" class="log" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>Payment Data Check</h3>
            <button onclick="checkPaymentData()">Check Payment Data</button>
            <div id="paymentStatus" class="status" style="display: none;"></div>
            <div id="paymentData" class="log" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>Payment Queries</h3>
            <button onclick="debugPaymentQueries()">Debug Payment Queries</button>
            <div id="paymentQueryStatus" class="status" style="display: none;"></div>
            <div id="paymentQueryData" class="log" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>Fix Payment Status</h3>
            <button onclick="fixPaymentStatus()">Fix All Payment Statuses</button>
            <div id="fixStatus" class="status" style="display: none;"></div>
            <div id="fixLog" class="log" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>Quick Actions</h3>
            <button onclick="runFullDiagnostic()">Run Full Diagnostic</button>
            <button onclick="refreshAdminDashboard()">Refresh Admin Dashboard</button>
            <div id="quickStatus" class="status" style="display: none;"></div>
            <div id="quickLog" class="log" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>Emergency Fix for Current User</h3>
            <button onclick="fixCurrentUserPayment()">Fix Current User Payment</button>
            <button onclick="addTestPaymentToCurrentUser()">Add Test Payment to Current User</button>
            <button onclick="addRealPaymentToCurrentUser()">Add Real Payment Data</button>
            <button onclick="checkSpecificPaymentError()">Check Payment Errors</button>
            <button onclick="testPaymentFunction()">Test Payment Function</button>
            <div id="emergencyStatus" class="status" style="display: none;"></div>
            <div id="emergencyLog" class="log" style="display: none;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLAHgSs8caqBdjbuNqUFs21vb24NO28_U",
            authDomain: "edusetgo-c895f.firebaseapp.com",
            projectId: "edusetgo-c895f",
            storageBucket: "edusetgo-c895f.firebasestorage.app",
            messagingSenderId: "356614273448",
            appId: "1:356614273448:web:ab2de825d2c810cbc9459d",
            measurementId: "G-N5JFFCJ1L2"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();

        // Helper function to show status
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        // Check authentication
        function checkAuth() {
            showStatus('authStatus', 'warning', 'Checking authentication...');
            const logDiv = document.getElementById('authData');
            logDiv.style.display = 'block';
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    showStatus('authStatus', 'success', 'User is authenticated');
                    logDiv.textContent = `User: ${user.email}\nUID: ${user.uid}\nDisplay Name: ${user.displayName || 'Not set'}`;
                } else {
                    showStatus('authStatus', 'error', 'User is not authenticated');
                    logDiv.textContent = 'No user is currently signed in.';
                }
            });
        }

        // Check user document
        function checkUserDocument() {
            const user = auth.currentUser;
            if (!user) {
                showStatus('userStatus', 'error', 'Please log in first');
                return;
            }

            showStatus('userStatus', 'warning', 'Checking user document...');
            const logDiv = document.getElementById('userData');
            logDiv.style.display = 'block';
            logDiv.textContent = 'Loading user document...\n';

            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        showStatus('userStatus', 'success', 'User document found');
                        logDiv.textContent = JSON.stringify(userData, null, 2);
                    } else {
                        showStatus('userStatus', 'error', 'User document not found');
                        logDiv.textContent = 'User document does not exist in Firestore.';
                    }
                })
                .catch(error => {
                    showStatus('userStatus', 'error', 'Error: ' + error.message);
                    logDiv.textContent = 'Error: ' + error.message;
                });
        }

        // Check payment data
        function checkPaymentData() {
            const user = auth.currentUser;
            if (!user) {
                showStatus('paymentStatus', 'error', 'Please log in first');
                return;
            }

            showStatus('paymentStatus', 'warning', 'Checking payment data...');
            const logDiv = document.getElementById('paymentData');
            logDiv.style.display = 'block';
            logDiv.textContent = 'Checking payment data for user: ' + user.email + '\n';

            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (!doc.exists) {
                        throw new Error('User document not found');
                    }

                    const userData = doc.data();
                    const paymentFields = [
                        'paymentStatus', 'paymentMethod', 'paymentId', 'paymentAmount', 
                        'paymentDate', 'packageType', 'packageName', 'paymentHistory'
                    ];

                    logDiv.textContent += 'Payment-related fields:\n';
                    paymentFields.forEach(field => {
                        if (userData.hasOwnProperty(field)) {
                            logDiv.textContent += `${field}: ${JSON.stringify(userData[field])}\n`;
                        } else {
                            logDiv.textContent += `${field}: NOT SET\n`;
                        }
                    });

                    const hasPaymentData = paymentFields.some(field => userData.hasOwnProperty(field));
                    if (hasPaymentData) {
                        showStatus('paymentStatus', 'success', 'Payment data found');
                    } else {
                        showStatus('paymentStatus', 'warning', 'No payment data found');
                    }
                })
                .catch(error => {
                    showStatus('paymentStatus', 'error', 'Error: ' + error.message);
                    logDiv.textContent += 'ERROR: ' + error.message + '\n';
                });
        }

        // Debug payment queries like admin dashboard does
        function debugPaymentQueries() {
            showStatus('paymentQueryStatus', 'warning', 'Running payment queries...');
            const dataDiv = document.getElementById('paymentQueryData');
            dataDiv.style.display = 'block';
            dataDiv.textContent = 'Running queries...\n';

            let results = {};

            // Query 1: Users with paymentStatus = 'paid' (what admin dashboard uses)
            db.collection('users')
                .where('paymentStatus', '==', 'paid')
                .get()
                .then(querySnapshot => {
                    results.paidStatusUsers = [];
                    querySnapshot.forEach(doc => {
                        const userData = doc.data();
                        results.paidStatusUsers.push({
                            uid: doc.id,
                            email: userData.email,
                            paymentAmount: userData.paymentAmount,
                            paymentHistory: userData.paymentHistory,
                            paymentId: userData.paymentId
                        });
                    });

                    // Display results
                    showStatus('paymentQueryStatus', 'success', 'Queries completed');
                    dataDiv.textContent = `PAYMENT QUERY RESULTS:\n\n` +
                        `Users with paymentStatus='paid' (Admin Dashboard Query): ${results.paidStatusUsers.length}\n` +
                        JSON.stringify(results.paidStatusUsers, null, 2);
                })
                .catch(error => {
                    showStatus('paymentQueryStatus', 'error', 'Error: ' + error.message);
                    dataDiv.textContent = 'ERROR: ' + error.message;
                    console.error('Error running payment queries:', error);
                });
        }

        // Fix payment status for all users who have payment data but missing paymentStatus
        function fixPaymentStatus() {
            showStatus('fixStatus', 'warning', 'Fixing payment statuses...');
            const logDiv = document.getElementById('fixLog');
            logDiv.style.display = 'block';
            logDiv.textContent = 'Starting payment status fix...\n';

            let fixedCount = 0;
            let totalChecked = 0;

            // Get all users
            db.collection('users').get()
                .then(querySnapshot => {
                    const batch = db.batch();

                    querySnapshot.forEach(doc => {
                        const userData = doc.data();
                        totalChecked++;

                        // Check if user has payment data but missing paymentStatus
                        const hasPaymentData = userData.paymentAmount ||
                                             userData.paymentId ||
                                             (userData.paymentHistory && userData.paymentHistory.length > 0);

                        const missingPaymentStatus = !userData.paymentStatus || userData.paymentStatus !== 'paid';

                        if (hasPaymentData && missingPaymentStatus) {
                            logDiv.textContent += `Fixing user: ${userData.email} (${doc.id})\n`;

                            // Prepare update data
                            const updateData = {
                                paymentStatus: 'paid',
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            };

                            // If no payment method is set, set it to razorpay
                            if (!userData.paymentMethod) {
                                updateData.paymentMethod = 'razorpay';
                            }

                            // If no payment date is set but we have payment data, set current timestamp
                            if (!userData.paymentDate && hasPaymentData) {
                                updateData.paymentDate = firebase.firestore.FieldValue.serverTimestamp();
                            }

                            batch.update(doc.ref, updateData);
                            fixedCount++;
                        }
                    });

                    if (fixedCount > 0) {
                        logDiv.textContent += `\nCommitting batch update for ${fixedCount} users...\n`;

                        return batch.commit().then(() => {
                            showStatus('fixStatus', 'success', `Fixed ${fixedCount} out of ${totalChecked} users`);
                            logDiv.textContent += `SUCCESS: Fixed payment status for ${fixedCount} users\n`;
                        });
                    } else {
                        showStatus('fixStatus', 'success', `No fixes needed. All ${totalChecked} users are properly configured.`);
                        logDiv.textContent += `No payment status fixes needed.\n`;
                    }
                })
                .catch(error => {
                    showStatus('fixStatus', 'error', 'Error: ' + error.message);
                    logDiv.textContent += 'ERROR: ' + error.message + '\n';
                    console.error('Error fixing payment statuses:', error);
                });
        }

        // Run full diagnostic
        function runFullDiagnostic() {
            showStatus('quickStatus', 'warning', 'Running full diagnostic...');
            const logDiv = document.getElementById('quickLog');
            logDiv.style.display = 'block';
            logDiv.textContent = 'Starting full diagnostic...\n';

            // Run all checks in sequence
            Promise.resolve()
                .then(() => {
                    logDiv.textContent += '1. Checking authentication...\n';
                    checkAuth();
                    return new Promise(resolve => setTimeout(resolve, 1000));
                })
                .then(() => {
                    logDiv.textContent += '2. Checking user document...\n';
                    checkUserDocument();
                    return new Promise(resolve => setTimeout(resolve, 2000));
                })
                .then(() => {
                    logDiv.textContent += '3. Checking payment data...\n';
                    checkPaymentData();
                    return new Promise(resolve => setTimeout(resolve, 2000));
                })
                .then(() => {
                    showStatus('quickStatus', 'success', 'Full diagnostic completed');
                    logDiv.textContent += '\nFull diagnostic completed!\n';
                })
                .catch(error => {
                    showStatus('quickStatus', 'error', 'Diagnostic failed: ' + error.message);
                    logDiv.textContent += '\nDiagnostic failed: ' + error.message + '\n';
                });
        }

        // Refresh admin dashboard
        function refreshAdminDashboard() {
            showStatus('quickStatus', 'warning', 'Refreshing admin dashboard...');
            const logDiv = document.getElementById('quickLog');
            logDiv.style.display = 'block';
            logDiv.textContent = 'Refreshing admin dashboard...\n';

            // Open admin dashboard in new tab
            const adminUrl = window.location.origin + '/admin.html';
            logDiv.textContent += 'Opening admin dashboard: ' + adminUrl + '\n';

            window.open(adminUrl, '_blank');

            showStatus('quickStatus', 'success', 'Admin dashboard opened in new tab');
            logDiv.textContent += 'Admin dashboard opened in new tab\n';
        }

        // Fix current user payment
        function fixCurrentUserPayment() {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                showStatus('emergencyStatus', 'error', 'Please log in first');
                return;
            }

            showStatus('emergencyStatus', 'warning', 'Fixing current user payment...');
            const logDiv = document.getElementById('emergencyLog');
            logDiv.style.display = 'block';
            logDiv.textContent = `Fixing payment for user: ${currentUser.email} (${currentUser.uid})\n`;

            // Get current user data
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (!doc.exists) {
                        throw new Error('User document does not exist');
                    }

                    const userData = doc.data();
                    logDiv.textContent += 'Current user data:\n' + JSON.stringify(userData, null, 2) + '\n\n';

                    // Check if user has any payment indicators
                    const hasPaymentData = userData.paymentAmount || userData.paymentId ||
                                         (userData.paymentHistory && userData.paymentHistory.length > 0);

                    if (!hasPaymentData) {
                        logDiv.textContent += 'No payment data found. User may not have made any payments.\n';
                        showStatus('emergencyStatus', 'warning', 'No payment data found for this user');
                        return;
                    }

                    // Prepare fix data
                    const fixData = {
                        paymentStatus: 'paid',
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // If no payment method, set default
                    if (!userData.paymentMethod) {
                        fixData.paymentMethod = 'razorpay';
                    }

                    // If no payment date but has payment data, set current date
                    if (!userData.paymentDate && hasPaymentData) {
                        fixData.paymentDate = firebase.firestore.FieldValue.serverTimestamp();
                    }

                    logDiv.textContent += 'Applying fix data:\n' + JSON.stringify(fixData, null, 2) + '\n';

                    return db.collection('users').doc(currentUser.uid).update(fixData);
                })
                .then(() => {
                    showStatus('emergencyStatus', 'success', 'Current user payment fixed successfully');
                    logDiv.textContent += 'SUCCESS: Current user payment status fixed\n';
                    logDiv.textContent += 'Please refresh the user dashboard to see the changes.\n';
                })
                .catch(error => {
                    showStatus('emergencyStatus', 'error', 'Error: ' + error.message);
                    logDiv.textContent += 'ERROR: ' + error.message + '\n';
                    console.error('Error fixing current user payment:', error);
                });
        }

        // Add test payment to current user
        function addTestPaymentToCurrentUser() {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                showStatus('emergencyStatus', 'error', 'Please log in first');
                return;
            }

            showStatus('emergencyStatus', 'warning', 'Adding test payment...');
            const logDiv = document.getElementById('emergencyLog');
            logDiv.style.display = 'block';
            logDiv.textContent = `Adding test payment for user: ${currentUser.email}\n`;

            // Create test payment data
            const testPayment = {
                paymentId: 'pay_test_' + Date.now(),
                amount: 100,
                packageType: 'test',
                packageName: 'Test Package',
                date: new Date(), // Use regular Date instead of serverTimestamp for arrays
                status: 'paid',
                userId: currentUser.uid,
                userEmail: currentUser.email
            };

            logDiv.textContent += 'Test payment data:\n' + JSON.stringify(testPayment, null, 2) + '\n';

            // Get current user data to append to payment history
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    const userData = doc.exists ? doc.data() : {};
                    const paymentHistory = userData.paymentHistory || [];

                    // Add test payment to history
                    paymentHistory.push(testPayment);

                    const updateData = {
                        paymentStatus: 'paid',
                        paymentMethod: 'razorpay',
                        paymentId: testPayment.paymentId,
                        paymentAmount: testPayment.amount,
                        packageType: testPayment.packageType,
                        packageName: testPayment.packageName,
                        paymentDate: firebase.firestore.FieldValue.serverTimestamp(),
                        paymentHistory: paymentHistory,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    logDiv.textContent += 'Updating user document...\n';

                    return db.collection('users').doc(currentUser.uid).set(updateData, { merge: true });
                })
                .then(() => {
                    showStatus('emergencyStatus', 'success', 'Test payment added successfully');
                    logDiv.textContent += 'SUCCESS: Test payment added to user account\n';
                    logDiv.textContent += 'Please refresh the user dashboard to see the payment.\n';
                })
                .catch(error => {
                    showStatus('emergencyStatus', 'error', 'Error: ' + error.message);
                    logDiv.textContent += 'ERROR: ' + error.message + '\n';
                    console.error('Error adding test payment:', error);
                });
        }

        // Add real payment data to current user (based on Razorpay payment)
        function addRealPaymentToCurrentUser() {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                showStatus('emergencyStatus', 'error', 'Please log in first');
                return;
            }

            showStatus('emergencyStatus', 'warning', 'Adding real payment data...');
            const logDiv = document.getElementById('emergencyLog');
            logDiv.style.display = 'block';
            logDiv.textContent = `Adding real payment data for user: ${currentUser.email}\n`;

            // Based on the Razorpay screenshot, create realistic payment data
            const realPayment = {
                paymentId: 'pay_RCyYoAMZoAYrjp', // From Razorpay screenshot
                amount: 222, // From Razorpay screenshot
                packageType: 'custom',
                packageName: 'Custom Package',
                date: new Date('2024-09-02T20:30:00Z'), // From Razorpay screenshot
                status: 'paid',
                userId: currentUser.uid,
                userEmail: currentUser.email,
                paymentMethod: 'razorpay'
            };

            // Get current user data
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    const userData = doc.exists ? doc.data() : {};
                    const paymentHistory = userData.paymentHistory || [];

                    // Add real payment to history
                    paymentHistory.push(realPayment);

                    const updateData = {
                        paymentStatus: 'paid',
                        paymentMethod: 'razorpay',
                        paymentId: realPayment.paymentId,
                        paymentAmount: realPayment.amount,
                        packageType: realPayment.packageType,
                        packageName: realPayment.packageName,
                        paymentDate: firebase.firestore.Timestamp.fromDate(realPayment.date),
                        paymentHistory: paymentHistory,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    logDiv.textContent += 'Real payment data (from Razorpay):\n' + JSON.stringify(realPayment, null, 2) + '\n';
                    logDiv.textContent += 'Updating user document...\n';

                    return db.collection('users').doc(currentUser.uid).set(updateData, { merge: true });
                })
                .then(() => {
                    showStatus('emergencyStatus', 'success', 'Real payment data added successfully');
                    logDiv.textContent += 'SUCCESS: Real payment data added to user account\n';
                    logDiv.textContent += 'Payment ID: ' + realPayment.paymentId + '\n';
                    logDiv.textContent += 'Amount: ₹' + realPayment.amount + '\n';
                    logDiv.textContent += 'Please refresh the user dashboard to see the payment.\n';
                })
                .catch(error => {
                    showStatus('emergencyStatus', 'error', 'Error: ' + error.message);
                    logDiv.textContent += 'ERROR: ' + error.message + '\n';
                    console.error('Error adding real payment:', error);
                });
        }

        // Check for payment errors in the payment_errors collection
        function checkSpecificPaymentError() {
            showStatus('emergencyStatus', 'warning', 'Checking for payment errors...');
            const logDiv = document.getElementById('emergencyLog');
            logDiv.style.display = 'block';
            logDiv.textContent = 'Checking payment_errors collection for failed payments...\n';

            // Look for payment errors related to the current user or specific payment IDs
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                logDiv.textContent += 'No user logged in. Checking all recent payment errors...\n';
            } else {
                logDiv.textContent += `Checking errors for user: ${currentUser.email} (${currentUser.uid})\n`;
            }

            // Query payment errors collection
            let query = db.collection('payment_errors').orderBy('timestamp', 'desc').limit(20);

            if (currentUser) {
                query = db.collection('payment_errors').where('userId', '==', currentUser.uid).orderBy('timestamp', 'desc').limit(10);
            }

            query.get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        logDiv.textContent += 'No payment errors found in the database.\n';
                        showStatus('emergencyStatus', 'success', 'No payment errors found');
                        return;
                    }

                    logDiv.textContent += `Found ${snapshot.size} payment error(s):\n\n`;

                    snapshot.forEach(doc => {
                        const errorData = doc.data();
                        logDiv.textContent += `Error ID: ${doc.id}\n`;
                        logDiv.textContent += `User: ${errorData.userEmail} (${errorData.userId})\n`;
                        logDiv.textContent += `Payment ID: ${errorData.paymentId}\n`;
                        logDiv.textContent += `Amount: ₹${errorData.amount}\n`;
                        logDiv.textContent += `Package: ${errorData.packageName}\n`;
                        logDiv.textContent += `Error: ${errorData.error.message}\n`;
                        logDiv.textContent += `Timestamp: ${errorData.timestamp ? errorData.timestamp.toDate() : 'Unknown'}\n`;
                        logDiv.textContent += '---\n';
                    });

                    showStatus('emergencyStatus', 'error', `Found ${snapshot.size} payment error(s)`);
                })
                .catch(error => {
                    logDiv.textContent += 'Error checking payment errors: ' + error.message + '\n';
                    showStatus('emergencyStatus', 'error', 'Error checking payment errors');
                    console.error('Error checking payment errors:', error);
                });
        }

        // Test the payment function directly
        function testPaymentFunction() {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                showStatus('emergencyStatus', 'error', 'Please log in first');
                return;
            }

            showStatus('emergencyStatus', 'warning', 'Testing payment function...');
            const logDiv = document.getElementById('emergencyLog');
            logDiv.style.display = 'block';
            logDiv.textContent = `Testing payment function for user: ${currentUser.email}\n`;

            // Create a mock Razorpay response
            const mockResponse = {
                razorpay_payment_id: 'pay_test_' + Date.now(),
                razorpay_order_id: 'order_test_' + Date.now(),
                razorpay_signature: 'test_signature'
            };

            const testAmount = 100;
            const testPackageType = 'test';
            const testPackageName = 'Test Package';

            logDiv.textContent += 'Mock payment data:\n';
            logDiv.textContent += JSON.stringify(mockResponse, null, 2) + '\n';
            logDiv.textContent += `Amount: ${testAmount}, Package: ${testPackageName}\n\n`;

            // Check if the function exists
            if (typeof window.handleSuccessfulPayment === 'function') {
                logDiv.textContent += '✅ handleSuccessfulPayment function found\n';
                logDiv.textContent += 'Calling function...\n';

                try {
                    window.handleSuccessfulPayment(mockResponse, testAmount, testPackageType, testPackageName);
                    logDiv.textContent += '✅ Function called successfully\n';
                    showStatus('emergencyStatus', 'success', 'Payment function test completed');
                } catch (error) {
                    logDiv.textContent += '❌ Error calling function: ' + error.message + '\n';
                    showStatus('emergencyStatus', 'error', 'Error: ' + error.message);
                }
            } else {
                logDiv.textContent += '❌ handleSuccessfulPayment function not found\n';
                logDiv.textContent += 'Available functions: ' + Object.keys(window).filter(key => key.includes('payment')).join(', ') + '\n';
                showStatus('emergencyStatus', 'error', 'Payment function not found');
            }
        }

    </script>
</body>
</html>
